<ion-header [translucent]="true">
</ion-header>

<ion-content class="ion-padding">

  <div [class]="'loading-placeholder ' + (formIsLoading ? '' : 'hidden')">
    <ion-spinner name="crescent"></ion-spinner>
  </div>

  <div class="centered-container">
    <div>
      <div class="signup-header">
        <h1>Créer un compte</h1>
        <div class="logo-container">
          <img src="assets/logo-light-cropped.png" alt="Training Day" width="120px" *ngIf="!useDarkMode">
          <img src="assets/logo-dark-cropped.png" alt="Training Day" width="120px" *ngIf="useDarkMode">
        </div>
      </div>

      <!-- Step 1: Email input -->
      <div *ngIf="currentStep === 1">
        <form [formGroup]="form" (submit)="validateEmail()">
          <ion-item class="ion-margin-vertical">
            <ion-input
              label="Email"
              label-placement="floating"
              formControlName="email"
              [errorText]="displayedError.email"
              autocomplete="email"
              appAutofill
            ></ion-input>
          </ion-item>

          <app-ux-button
            expand="full"
            type="submit"
            shape="round"
            [loading]="formIsLoading"
          >
            Continuer
          </app-ux-button>
        </form>

        <div class="divider-section">
          <hr/>
          <span class="divider-text">ou s'inscrire avec</span>
          <hr/>
        </div>

        <div class="social-buttons">
          <app-continue-with-google-button
            (action)="loginWithGoogle($event)"
            color="medium"
            expand="block"
            type="button"
            shape="round"
            fill="clear"
            size="small"
          ></app-continue-with-google-button>

          <app-continue-with-apple-button
            *ngIf="system == 'ios'"
            (action)="loginWithApple($event)"
            color="medium"
            expand="block"
            type="button"
            shape="round"
            fill="clear"
            size="small"
          ></app-continue-with-apple-button>
        </div>
      </div>

      <!-- Step 2: Firstname/Lastname -->
      <div *ngIf="currentStep === 2">
        <form [formGroup]="form" (submit)="validateNames()">
          <ion-item class="ion-margin-vertical">
            <ion-input
              label="Prénom"
              label-placement="floating"
              formControlName="firstname"
              [errorText]="displayedError.firstname"
            ></ion-input>
          </ion-item>

          <ion-item class="ion-margin-vertical">
            <ion-input
              label="Nom"
              label-placement="floating"
              formControlName="lastname"
              [errorText]="displayedError.lastname"
            ></ion-input>
          </ion-item>

          <app-ux-button
            expand="full"
            type="submit"
            shape="round"
            [loading]="formIsLoading"
          >
            Continuer
          </app-ux-button>
        </form>

        <ion-button
          expand="full"
          fill="clear"
          color="medium"
          (click)="goBack()"
        >
          Retour
        </ion-button>
      </div>

      <!-- Step 3: Password -->
      <div *ngIf="currentStep === 3">
        <form [formGroup]="form" (submit)="submitForm()">
          <ion-item class="ion-margin-vertical">
            <ion-input
              label="Mot de passe"
              label-placement="floating"
              formControlName="password"
              [type]="passwordToggle.value ? 'text' : 'password'"
              [errorText]="displayedError.password"
              autocomplete="new-password"
            ></ion-input>
            <ion-button
              color="medium"
              fill="clear"
              class="password-toggle"
              shape="round"
              (touchstart)="passwordToggle.toggle($event, true)"
              (touchend)="passwordToggle.toggle($event, false)"
              (mousedown)="passwordToggle.toggle($event, true)"
              (mouseup)="passwordToggle.toggle($event, false)"
            >
              <div>
                <ion-icon slot="end" name="eye"></ion-icon>
              </div>
            </ion-button>
          </ion-item>

          <ion-item class="ion-margin-vertical">
            <ion-input
              label="Confirmez le mot de passe"
              label-placement="floating"
              formControlName="password_confirm"
              [type]="passwordConfirmToggle.value ? 'text' : 'password'"
              [errorText]="displayedError.password_confirm"
              autocomplete="new-password"
            ></ion-input>
            <ion-button
              color="medium"
              fill="clear"
              class="password-toggle"
              shape="round"
              (touchstart)="passwordConfirmToggle.toggle($event, true)"
              (touchend)="passwordConfirmToggle.toggle($event, false)"
              (mousedown)="passwordConfirmToggle.toggle($event, true)"
              (mouseup)="passwordConfirmToggle.toggle($event, false)"
            >
              <div>
                <ion-icon slot="end" name="eye"></ion-icon>
              </div>
            </ion-button>
          </ion-item>

          <app-ux-button
            expand="full"
            type="submit"
            shape="round"
            [loading]="formIsLoading"
          >
            Créer le compte
          </app-ux-button>
        </form>

        <ion-button
          expand="full"
          fill="clear"
          color="medium"
          (click)="goBack()"
        >
          Retour
        </ion-button>
      </div>

      <!-- Step 4: Accept Conditions -->
      <div *ngIf="currentStep === 4">
        <div class="conditions-container">
          <h3>Conditions d'utilisation</h3>
          <p class="helper">Veuillez accepter nos conditions pour finaliser votre inscription</p>

          <div class="custom-checkbox-container" (click)="toggleConditions()">
            <div class="custom-checkbox" [class.checked]="form.get('acceptConditions')?.value">
              <ion-icon name="checkmark" *ngIf="form.get('acceptConditions')?.value"></ion-icon>
            </div>
            <div class="checkbox-text">
              J'accepte <a class="conditions-link" (click)="openCGU(); $event.stopPropagation()">les conditions générales d'utilisation</a>
            </div>
          </div>

          <div class="error-message" *ngIf="displayedError.acceptConditions">
            {{ displayedError.acceptConditions }}
          </div>
        </div>

        <ion-button
          expand="full"
          fill="outline"
          color="medium"
          shape="round"
          class="privacy-policy-button"
          (click)="openPrivacyPolicy()"
        >
          <ion-icon name="shield-checkmark-outline" slot="start"></ion-icon>
          Politique d'engagement de confidentialité
        </ion-button>

        <app-ux-button
          expand="full"
          type="button"
          shape="round"
          [loading]="formIsLoading"
          (click)="submitForm()"
        >
          Créer le compte
        </app-ux-button>

        <ion-button
          expand="full"
          fill="clear"
          color="medium"
          (click)="goBack()"
        >
          Retour
        </ion-button>
      </div>

      <p class="ion-margin-top login-link">
        <a routerLink="/login">Déjà un compte ? Se connecter</a>
      </p>

      <ion-button
        expand="full"
        fill="outline"
        color="medium"
        size="small"
        shape="round"
        class="privacy-policy-button"
        (click)="openPrivacyPolicy()"
      >
        <ion-icon name="shield-checkmark-outline" slot="start"></ion-icon>
        Politique de confidentialité
      </ion-button>
    </div>
  </div>
</ion-content>